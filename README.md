# KVM虚拟机管理系统项目文档

## 1. 项目概述

本项目是一个基于KVM技术的虚拟机管理系统，提供Web界面进行虚拟机的创建、启动、关闭、重启和删除等操作。系统采用前后端分离架构，后端使用Java Spring Boot框架与Libvirt API交互管理虚拟机，前端采用Vue 3构建用户界面。

## 2. 技术栈

### 2.1 后端技术
- **Java 21**: 主要开发语言
- **Spring Boot 3.5.4**: 应用框架
- **Libvirt Java API 0.5.2**: 与KVM虚拟机交互的底层库
- **JNA 5.13.0**: 本地库调用
- **Lombok**: 简化Java代码
- **SpringDoc OpenAPI**: API文档生成

### 2.2 前端技术
- **Vue 3.5.12**: 前端框架
- **Pinia 2.2.6**: 状态管理
- **Axios 1.7.7**: HTTP客户端
- **TypeScript 5.6.2**: 类型系统
- **Vite 5.4.10**: 构建工具

## 3. 系统架构

### 3.1 架构图
```
+------------------+      HTTP请求      +------------------+
|  前端Vue应用     |<----------------->|  Spring Boot后端 |
|  (VmList组件)    |                    |  (虚拟机控制器)  |
+------------------+                    +------------------+
                                            |
                                            |  Libvirt API调用
                                            v
+------------------+      KVM管理       +------------------+
|   虚拟机实例     |<------------------->|    Libvirt       |
|  (VM1, VM2...)   |                    |    (宿主机)      |
+------------------+                    +------------------+
```

### 3.2 核心模块

#### 3.2.1 连接管理模块
- **LibvirtConnectionService**: 管理与Libvirt的连接，提供连接初始化、状态检查和生命周期管理
- **LibvirtConfig**: 配置类，读取libvirt连接参数

#### 3.2.2 虚拟机管理模块
- **VirtualMachineService**: 核心业务逻辑，实现虚拟机的创建、启动、关闭、重启等操作
- **VirtualMachineController**: REST API控制器，处理前端请求
- **vm-template.xml**: KVM虚拟机XML配置模板

#### 3.2.3 数据模型
- **VmInfo**: 虚拟机信息数据传输对象
- **CreateVmRequest**: 创建虚拟机请求参数
- 其他请求/响应模型

#### 3.2.4 前端组件
- **VmList.vue**: 主要组件，包含虚拟机列表和操作界面
- **App.vue**: 应用入口组件

## 4. 核心功能

### 4.1 虚拟机生命周期管理
- **创建虚拟机**: 根据提供的参数或XML配置创建新的KVM虚拟机
- **启动虚拟机**: 启动指定的虚拟机实例
- **关闭虚拟机**: 正常关闭虚拟机
- **强制关闭**: 强制终止虚拟机进程
- **重启虚拟机**: 重启运行中的虚拟机
- **删除虚拟机**: 从宿主机中删除虚拟机配置

### 4.2 虚拟机监控
- **列表查询**: 获取所有虚拟机的状态信息
- **详情查看**: 获取指定虚拟机的详细配置和状态
- **资源监控**: 显示内存使用、CPU数量等资源信息

### 4.3 远程访问支持
- **VNC访问**: 提供虚拟机的VNC访问信息
- **RDP访问**: 支持通过RDP协议连接Windows虚拟机
- **SSH访问**: 支持通过SSH协议连接Linux虚拟机

### 4.4 虚拟机配置管理
- **参数创建**: 支持通过GUI设置虚拟机名称、内存、CPU等参数
- **密码修改**: 提供修改虚拟机内用户密码的功能

## 5. API接口设计

### 5.1 虚拟机管理接口
| 方法 | 路径 | 描述 |
|------|------|------|
| GET | /v1/vms | 获取所有虚拟机列表 |
| GET | /v1/vms/{name} | 获取指定虚拟机详情 |
| POST | /v1/vms | 创建新的虚拟机 |
| DELETE | /v1/vms/{name} | 删除指定虚拟机 |
| POST | /v1/vms/{name}/start | 启动虚拟机 |
| POST | /v1/vms/{name}/shutdown | 关闭虚拟机 |
| POST | /v1/vms/{name}/force-shutdown | 强制关闭虚拟机 |
| POST | /v1/vms/{name}/reboot | 重启虚拟机 |
| POST | /v1/vms/{name}/password | 修改虚拟机密码 |

## 6. 关键实现细节

### 6.1 虚拟机创建流程
1. 前端收集虚拟机配置参数（名称、内存、CPU等）
2. 后端接收请求，生成唯一UUID
3. 使用vm-template.xml模板，替换占位符生成XML配置
4. 通过Libvirt API定义并创建虚拟机
5. 返回创建结果给前端

### 6.2 Libvirt连接管理
- 采用延迟初始化策略，首次使用时建立连接
- 提供连接状态检查和重连机制
- 使用@PostConstruct和@PreDestroy管理生命周期
- 处理本地库依赖错误，提供详细错误提示

### 6.3 XML模板机制
- 使用占位符%s替换动态参数
- 模板包含完整的虚拟机配置：CPU、内存、磁盘、网卡、显示设备等
- 支持资源分区、电源管理、控制器配置等高级特性

## 7. 配置说明

### 7.1 后端配置参数
```yaml
libvirt:
  connection:
    # libvirt连接URI
    uri: ${LIBVIRT_URI:qemu:///system}
    # 连接超时时间（秒）
    timeout: 30
```

### 7.2 环境变量
- **LIBVIRT_URI**: 覆盖默认的libvirt连接URI
- **SWAGGER_ENABLED**: 是否启用Swagger文档（默认false）

## 8. 部署注意事项

1. **环境要求**:
   - Linux系统（支持KVM虚拟化）
   - 已安装libvirt库和QEMU/KVM
   - Java 21或更高版本

2. **权限配置**:
   - 系统级连接（qemu:///system）需要root或libvirt组权限
   - 用户级连接（qemu:///session）可使用普通用户

3. **网络配置**:
   - 默认使用"default"网络
   - 确保libvirt网络服务正常运行

## 9. 扩展建议

1. **Web VNC集成**: 使用noVNC替代外部VNC客户端
2. **资源监控图表**: 集成图表库显示资源使用趋势
3. **虚拟机模板**: 支持创建和管理虚拟机模板
4. **集群管理**: 扩展支持多节点KVM集群管理
5. **用户认证**: 增加用户登录和权限管理功能
6. **API密钥管理**: 支持第三方应用集成的API认证机制

## 10. 故障排除

1. **连接失败**:
   - 检查libvirtd服务是否运行
   - 验证连接URI和权限设置
   - 确认libvirt本地库是否正确安装

2. **虚拟机操作错误**:
   - 查看日志中的详细错误信息
   - 检查磁盘映像文件权限和路径
   - 验证网络配置是否正确

3. **性能问题**:
   - 调整虚拟机CPU和内存配置
   - 优化磁盘I/O设置
   - 考虑使用半虚拟化设备（virtio）